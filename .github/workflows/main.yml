name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    if: github.event_name == 'pull_request'
    runs-on: Linux
    env:
      NVIDIA_DRIVER_CAPABILITIES: all
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DISABLE_REQUIRE: 1
    container: &container_template
      image: 192.168.3.13:5000/dexsdk:1.1.1_py310_aliapt
      volumes:
        - "/cache:/cache"
        - "/usr/share/vulkan/icd.d:/usr/share/vulkan/icd.d"
        - "/usr/share/vulkan/implicit_layer.d:/usr/share/vulkan/implicit_layer.d"
        - "/usr/share/glvnd/egl_vendor.d:/usr/share/glvnd/egl_vendor.d"
        - "/tmp/.X11-unix:/tmp/.X11-unix"
        - "/dev/shm/shared:/dev/shm/shared"
      options: --memory 100g --gpus device=1 --shm-size 53687091200
    steps:
      - uses: actions/checkout@v4
      - name: start Lint check
        run: echo "start code style check"

  build:
    needs: lint
    runs-on: Linux
    env:
      NVIDIA_DRIVER_CAPABILITIES: all
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DISABLE_REQUIRE: 1
    container: *container_template
    steps:
      - uses: actions/checkout@v4
      - name: Build docs
        run: |
          echo "build docs"

  test:
    if: github.event_name == 'pull_request'
    needs: lint
    runs-on: Linux
    env:
      NVIDIA_DRIVER_CAPABILITIES: all
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DISABLE_REQUIRE: 1
    container: *container_template
    steps:
      - uses: actions/checkout@v4
      - name: Run tests
        run: echo "test start"

  publish:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: docs
    runs-on: Linux
    env:
      NVIDIA_DRIVER_CAPABILITIES: all
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DISABLE_REQUIRE: 1
    container: *container_template
    steps:
      - uses: actions/checkout@v4
      - name: publish docs
        run: echo "start docs stage"
      - name: publish package
        run: echo "start publish stage"
      # - name: Push to PyPI
      #   env:
      #     TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
      #     TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      #   run: twine upload dist/*